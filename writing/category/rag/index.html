<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content=Dewey.Amer><link href=../python/ rel=prev><link href=../../archive/2024/ rel=next><link rel=icon href=../../../assets/images/favicon.png><meta name=generator content="mkdocs-1.6.0, mkdocs-material-9.5.31"><title>RAG - What's wrong with you?</title><link rel=stylesheet href=../../../assets/stylesheets/main.3cba04c6.min.css><link rel=stylesheet href=../../../assets/stylesheets/palette.06af60db.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme=slate data-md-color-primary=black data-md-color-accent=indigo> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#rag class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class="md-header md-header--shadow md-header--lifted" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../../.. title="What's wrong with you?" class="md-header__button md-logo" aria-label="What's wrong with you?" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> What's wrong with you? </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> RAG </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media=(prefers-color-scheme) data-md-color-scheme=slate data-md-color-primary=black data-md-color-accent=indigo aria-label="Switch to light mode" type=radio name=__palette id=__palette_0> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1M8 13h8v-2H8v2m9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1 0 1.71-1.39 3.1-3.1 3.1h-4V17h4a5 5 0 0 0 5-5 5 5 0 0 0-5-5Z"/></svg> </label> <input class=md-option data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo aria-label="Switch to dark mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_2 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3Z"/></svg> </label> <input class=md-option data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme=slate data-md-color-primary=black data-md-color-accent=indigo aria-label="Switch to system preference" type=radio name=__palette id=__palette_2> <label class="md-header__button md-icon" title="Switch to system preference" for=__palette_0 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5M7 15a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3Z"/></svg> </label> </form> <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </label> <nav class=md-search__options aria-label=Search> <a href=javascript:void(0) class="md-search__icon md-icon" title=Share aria-label=Share data-clipboard data-clipboard-text data-md-component=search-share tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08Z"/></svg> </a> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> </nav> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../../.. class=md-tabs__link> Home </a> </li> <li class="md-tabs__item md-tabs__item--active"> <a href=../../ class=md-tabs__link> Blog </a> </li> <li class=md-tabs__item> <a href=../../../photography/ class=md-tabs__link> Photography </a> </li> </ul> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../../.. title="What's wrong with you?" class="md-nav__button md-logo" aria-label="What's wrong with you?" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg> </a> What's wrong with you? </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../.. class=md-nav__link> <span class=md-ellipsis> Home </span> </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2 checked> <div class="md-nav__link md-nav__container"> <a href=../../ class="md-nav__link "> <span class=md-ellipsis> Blog </span> </a> <label class="md-nav__link " for=__nav_2 id=__nav_2_label tabindex> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_2_label aria-expanded=true> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> Blog </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_2_2> <label class=md-nav__link for=__nav_2_2 id=__nav_2_2_label tabindex> <span class=md-ellipsis> Archive </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_2_label aria-expanded=false> <label class=md-nav__title for=__nav_2_2> <span class="md-nav__icon md-icon"></span> Archive </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../archive/2024/ class=md-nav__link> <span class=md-ellipsis> 2024 </span> </a> </li> <li class=md-nav__item> <a href=../../archive/2023/ class=md-nav__link> <span class=md-ellipsis> 2023 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_3 checked> <label class=md-nav__link for=__nav_2_3 id=__nav_2_3_label tabindex> <span class=md-ellipsis> Categories </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_3_label aria-expanded=true> <label class=md-nav__title for=__nav_2_3> <span class="md-nav__icon md-icon"></span> Categories </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../conversations/ class=md-nav__link> <span class=md-ellipsis> Conversations </span> </a> </li> <li class=md-nav__item> <a href=../embedding/ class=md-nav__link> <span class=md-ellipsis> Embedding </span> </a> </li> <li class=md-nav__item> <a href=../python/ class=md-nav__link> <span class=md-ellipsis> Python </span> </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <span class=md-ellipsis> RAG </span> <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> RAG </span> </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#query-understanding class=md-nav__link> <span class=md-ellipsis> Query understanding </span> </a> </li> <li class=md-nav__item> <a href=#how-to-manage-chat-history-for-your-chatbot class=md-nav__link> <span class=md-ellipsis> How to manage chat history for your chatbot? </span> </a> </li> <li class=md-nav__item> <a href=#embedding-fine-tuning class=md-nav__link> <span class=md-ellipsis> Embedding fine-tuning </span> </a> </li> <li class=md-nav__item> <a href=#prompt-optim class=md-nav__link> <span class=md-ellipsis> Prompt Optim </span> </a> </li> <li class=md-nav__item> <a href=#rag-evaluate class=md-nav__link> <span class=md-ellipsis> RAG-evaluate </span> </a> </li> <li class=md-nav__item> <a href=#gptrag class=md-nav__link> <span class=md-ellipsis> 漫谈GPT&amp;RAG </span> </a> </li> <li class=md-nav__item> <a href=#rag-survey class=md-nav__link> <span class=md-ellipsis> RAG-Survey </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../../photography/ class=md-nav__link> <span class=md-ellipsis> Photography </span> </a> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#query-understanding class=md-nav__link> <span class=md-ellipsis> Query understanding </span> </a> </li> <li class=md-nav__item> <a href=#how-to-manage-chat-history-for-your-chatbot class=md-nav__link> <span class=md-ellipsis> How to manage chat history for your chatbot? </span> </a> </li> <li class=md-nav__item> <a href=#embedding-fine-tuning class=md-nav__link> <span class=md-ellipsis> Embedding fine-tuning </span> </a> </li> <li class=md-nav__item> <a href=#prompt-optim class=md-nav__link> <span class=md-ellipsis> Prompt Optim </span> </a> </li> <li class=md-nav__item> <a href=#rag-evaluate class=md-nav__link> <span class=md-ellipsis> RAG-evaluate </span> </a> </li> <li class=md-nav__item> <a href=#gptrag class=md-nav__link> <span class=md-ellipsis> 漫谈GPT&amp;RAG </span> </a> </li> <li class=md-nav__item> <a href=#rag-survey class=md-nav__link> <span class=md-ellipsis> RAG-Survey </span> </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <div class=md-content__inner> <header class=md-typeset> <h1 id=rag>RAG<a class=headerlink href=#rag title="Permanent link">&para;</a></h1> </header> <article class="md-post md-post--excerpt"> <header class=md-post__header> <nav class="md-post__authors md-typeset"> <span class=md-author> <img src=https://github.com/deweyamer.png alt=Dewey> </span> </nav> <div class="md-post__meta md-meta"> <ul class=md-meta__list> <li class=md-meta__item> <time datetime="2024-08-01 00:00:00">August 1, 2024</time></li> <li class=md-meta__item> in <a href=./ class=md-meta__link>RAG</a></li> <li class=md-meta__item> 11 min read </li> </ul> </div> </header> <div class="md-post__content md-typeset"> <h2 id=query-understanding><a href=../../2024/08/01/query-understanding/ class=toclink>Query understanding</a></h2> <p>Query understanding is a complicated issue. It involves not only processing the query itself but also the procedure for constructing data indexes and retrieval.</p> <p>So, I will follow these steps:</p> <ul> <li>Constructing data indexes</li> <li>Retrieval</li> <li>Query understanding</li> </ul> <h3 id=constructing-data-indexes><a class=toclink href=../../2024/08/01/query-understanding/#constructing-data-indexes>Constructing data indexes</a></h3> <p>One major limitation is that the query we embed and the text we search for often don't have a direct match, leading to suboptimal results. A common method to improve this is to extract information from a document and use it to answer a question. We can also be creative in how we extract, summarize, and generate potential questions to improve our embeddings.</p> <p>For example, instead of using just a text chunk we could try to:</p> <ol> <li>extract key words and themes</li> <li>extract hypothetical questions</li> <li>generate a summary of the text</li> </ol> <div class="language-python highlight"><pre><span></span><code><span id=__span-20-1><a id=__codelineno-20-1 name=__codelineno-20-1 href=#__codelineno-20-1></a><span class=k>class</span> <span class=nc>Extraction</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span><span id=__span-20-2><a id=__codelineno-20-2 name=__codelineno-20-2 href=#__codelineno-20-2></a>    <span class=n>topic</span><span class=p>:</span> <span class=nb>str</span>
</span><span id=__span-20-3><a id=__codelineno-20-3 name=__codelineno-20-3 href=#__codelineno-20-3></a>    <span class=n>summary</span><span class=p>:</span> <span class=nb>str</span>
</span><span id=__span-20-4><a id=__codelineno-20-4 name=__codelineno-20-4 href=#__codelineno-20-4></a>    <span class=n>hypothetical_questions</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span>
</span><span id=__span-20-5><a id=__codelineno-20-5 name=__codelineno-20-5 href=#__codelineno-20-5></a>        <span class=n>default_factory</span><span class=o>=</span><span class=nb>list</span><span class=p>,</span>
</span><span id=__span-20-6><a id=__codelineno-20-6 name=__codelineno-20-6 href=#__codelineno-20-6></a>        <span class=n>description</span><span class=o>=</span><span class=s2>&quot;Hypothetical questions that this document could answer&quot;</span><span class=p>,</span>
</span><span id=__span-20-7><a id=__codelineno-20-7 name=__codelineno-20-7 href=#__codelineno-20-7></a>    <span class=p>)</span>
</span><span id=__span-20-8><a id=__codelineno-20-8 name=__codelineno-20-8 href=#__codelineno-20-8></a>    <span class=n>keywords</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span>
</span><span id=__span-20-9><a id=__codelineno-20-9 name=__codelineno-20-9 href=#__codelineno-20-9></a>        <span class=n>default_factory</span><span class=o>=</span><span class=nb>list</span><span class=p>,</span> <span class=n>description</span><span class=o>=</span><span class=s2>&quot;Keywords that this document is about&quot;</span>
</span><span id=__span-20-10><a id=__codelineno-20-10 name=__codelineno-20-10 href=#__codelineno-20-10></a>    <span class=p>)</span>
</span><span id=__span-20-11><a id=__codelineno-20-11 name=__codelineno-20-11 href=#__codelineno-20-11></a>
</span><span id=__span-20-12><a id=__codelineno-20-12 name=__codelineno-20-12 href=#__codelineno-20-12></a><span class=n>text_chunk</span> <span class=o>=</span> <span class=s2>&quot;&quot;&quot;</span>
</span><span id=__span-20-13><a id=__codelineno-20-13 name=__codelineno-20-13 href=#__codelineno-20-13></a><span class=s2>## Simple RAG</span>
</span><span id=__span-20-14><a id=__codelineno-20-14 name=__codelineno-20-14 href=#__codelineno-20-14></a>
</span><span id=__span-20-15><a id=__codelineno-20-15 name=__codelineno-20-15 href=#__codelineno-20-15></a><span class=s2>**What is it?**</span>
</span><span id=__span-20-16><a id=__codelineno-20-16 name=__codelineno-20-16 href=#__codelineno-20-16></a>
</span><span id=__span-20-17><a id=__codelineno-20-17 name=__codelineno-20-17 href=#__codelineno-20-17></a><span class=s2>The simplest implementation of RAG embeds a user query and do a single embedding search in a vector database, like a vector store of Wikipedia articles. However, this approach often falls short when dealing with complex queries and diverse data sources.</span>
</span><span id=__span-20-18><a id=__codelineno-20-18 name=__codelineno-20-18 href=#__codelineno-20-18></a>
</span><span id=__span-20-19><a id=__codelineno-20-19 name=__codelineno-20-19 href=#__codelineno-20-19></a><span class=s2>**What are the limitations?**</span>
</span><span id=__span-20-20><a id=__codelineno-20-20 name=__codelineno-20-20 href=#__codelineno-20-20></a>
</span><span id=__span-20-21><a id=__codelineno-20-21 name=__codelineno-20-21 href=#__codelineno-20-21></a><span class=s2>- **Query-Document Mismatch:** It assumes that the query and document embeddings will align in the vector space, which is often not the case.</span>
</span><span id=__span-20-22><a id=__codelineno-20-22 name=__codelineno-20-22 href=#__codelineno-20-22></a><span class=s2>    - Query: &quot;Tell me about climate change effects on marine life.&quot;</span>
</span><span id=__span-20-23><a id=__codelineno-20-23 name=__codelineno-20-23 href=#__codelineno-20-23></a><span class=s2>    - Issue: The model might retrieve documents related to general climate change or marine life, missing the specific intersection of both topics.</span>
</span><span id=__span-20-24><a id=__codelineno-20-24 name=__codelineno-20-24 href=#__codelineno-20-24></a><span class=s2>- **Monolithic Search Backend:** It relies on a single search method and backend, reducing flexibility and the ability to handle multiple data sources.</span>
</span><span id=__span-20-25><a id=__codelineno-20-25 name=__codelineno-20-25 href=#__codelineno-20-25></a><span class=s2>    - Query: &quot;Latest research in quantum computing.&quot;</span>
</span><span id=__span-20-26><a id=__codelineno-20-26 name=__codelineno-20-26 href=#__codelineno-20-26></a><span class=s2>    - Issue: The model might only search in a general science database, missing out on specialized quantum computing resources.</span>
</span><span id=__span-20-27><a id=__codelineno-20-27 name=__codelineno-20-27 href=#__codelineno-20-27></a><span class=s2>- **Text Search Limitations:** The model is restricted to simple text queries without the nuances of advanced search features.</span>
</span><span id=__span-20-28><a id=__codelineno-20-28 name=__codelineno-20-28 href=#__codelineno-20-28></a><span class=s2>    - Query: &quot;what problems did we fix last week&quot;</span>
</span><span id=__span-20-29><a id=__codelineno-20-29 name=__codelineno-20-29 href=#__codelineno-20-29></a><span class=s2>    - Issue: cannot be answered by a simple text search since documents that contain problem, last week are going to be present at every week.</span>
</span><span id=__span-20-30><a id=__codelineno-20-30 name=__codelineno-20-30 href=#__codelineno-20-30></a><span class=s2>- **Limited Planning Ability:** It fails to consider additional contextual information that could refine the search results.</span>
</span><span id=__span-20-31><a id=__codelineno-20-31 name=__codelineno-20-31 href=#__codelineno-20-31></a><span class=s2>    - Query: &quot;Tips for first-time Europe travelers.&quot;</span>
</span><span id=__span-20-32><a id=__codelineno-20-32 name=__codelineno-20-32 href=#__codelineno-20-32></a><span class=s2>    - Issue: The model might provide general travel advice, ignoring the specific context of first-time travelers or European destinations.</span>
</span><span id=__span-20-33><a id=__codelineno-20-33 name=__codelineno-20-33 href=#__codelineno-20-33></a><span class=s2>&quot;&quot;&quot;</span>
</span><span id=__span-20-34><a id=__codelineno-20-34 name=__codelineno-20-34 href=#__codelineno-20-34></a>
</span><span id=__span-20-35><a id=__codelineno-20-35 name=__codelineno-20-35 href=#__codelineno-20-35></a><span class=n>extractions</span> <span class=o>=</span> <span class=n>client</span><span class=o>.</span><span class=n>chat</span><span class=o>.</span><span class=n>completions</span><span class=o>.</span><span class=n>create</span><span class=p>(</span>
</span><span id=__span-20-36><a id=__codelineno-20-36 name=__codelineno-20-36 href=#__codelineno-20-36></a>    <span class=n>model</span><span class=o>=</span><span class=s2>&quot;gpt-4-1106-preview&quot;</span><span class=p>,</span>
</span><span id=__span-20-37><a id=__codelineno-20-37 name=__codelineno-20-37 href=#__codelineno-20-37></a>    <span class=n>stream</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-20-38><a id=__codelineno-20-38 name=__codelineno-20-38 href=#__codelineno-20-38></a>    <span class=n>response_model</span><span class=o>=</span><span class=n>Iterable</span><span class=p>[</span><span class=n>Extraction</span><span class=p>],</span>
</span><span id=__span-20-39><a id=__codelineno-20-39 name=__codelineno-20-39 href=#__codelineno-20-39></a>    <span class=n>messages</span><span class=o>=</span><span class=p>[</span>
</span><span id=__span-20-40><a id=__codelineno-20-40 name=__codelineno-20-40 href=#__codelineno-20-40></a>        <span class=p>{</span>
</span><span id=__span-20-41><a id=__codelineno-20-41 name=__codelineno-20-41 href=#__codelineno-20-41></a>            <span class=s2>&quot;role&quot;</span><span class=p>:</span> <span class=s2>&quot;system&quot;</span><span class=p>,</span>
</span><span id=__span-20-42><a id=__codelineno-20-42 name=__codelineno-20-42 href=#__codelineno-20-42></a>            <span class=s2>&quot;content&quot;</span><span class=p>:</span> <span class=s2>&quot;Your role is to extract chunks from the following and create a set of topics.&quot;</span><span class=p>,</span>
</span><span id=__span-20-43><a id=__codelineno-20-43 name=__codelineno-20-43 href=#__codelineno-20-43></a>        <span class=p>},</span>
</span><span id=__span-20-44><a id=__codelineno-20-44 name=__codelineno-20-44 href=#__codelineno-20-44></a>        <span class=p>{</span><span class=s2>&quot;role&quot;</span><span class=p>:</span> <span class=s2>&quot;user&quot;</span><span class=p>,</span> <span class=s2>&quot;content&quot;</span><span class=p>:</span> <span class=n>text_chunk</span><span class=p>},</span>
</span><span id=__span-20-45><a id=__codelineno-20-45 name=__codelineno-20-45 href=#__codelineno-20-45></a>    <span class=p>],</span>
</span><span id=__span-20-46><a id=__codelineno-20-46 name=__codelineno-20-46 href=#__codelineno-20-46></a><span class=p>)</span>
</span><span id=__span-20-47><a id=__codelineno-20-47 name=__codelineno-20-47 href=#__codelineno-20-47></a>
</span><span id=__span-20-48><a id=__codelineno-20-48 name=__codelineno-20-48 href=#__codelineno-20-48></a><span class=k>for</span> <span class=n>extraction</span> <span class=ow>in</span> <span class=n>extractions</span><span class=p>:</span>
</span><span id=__span-20-49><a id=__codelineno-20-49 name=__codelineno-20-49 href=#__codelineno-20-49></a>    <span class=n>pprint</span><span class=p>(</span><span class=n>extraction</span><span class=o>.</span><span class=n>model_dump</span><span class=p>())</span>
</span></code></pre></div> <div class="language-text highlight"><pre><span></span><code><span id=__span-21-1><a id=__codelineno-21-1 name=__codelineno-21-1 href=#__codelineno-21-1></a>{&#39;hypothetical_questions&#39;: [&#39;What is the basic concept behind simple RAG?&#39;,
</span><span id=__span-21-2><a id=__codelineno-21-2 name=__codelineno-21-2 href=#__codelineno-21-2></a>                            &#39;How does simple RAG work for information &#39;
</span><span id=__span-21-3><a id=__codelineno-21-3 name=__codelineno-21-3 href=#__codelineno-21-3></a>                            &#39;retrieval?&#39;],
</span><span id=__span-21-4><a id=__codelineno-21-4 name=__codelineno-21-4 href=#__codelineno-21-4></a> &#39;keywords&#39;: [&#39;Simple RAG&#39;,
</span><span id=__span-21-5><a id=__codelineno-21-5 name=__codelineno-21-5 href=#__codelineno-21-5></a>              &#39;Retrieval-Augmented Generation&#39;,
</span><span id=__span-21-6><a id=__codelineno-21-6 name=__codelineno-21-6 href=#__codelineno-21-6></a>              &#39;user query&#39;,
</span><span id=__span-21-7><a id=__codelineno-21-7 name=__codelineno-21-7 href=#__codelineno-21-7></a>              &#39;embedding search&#39;,
</span><span id=__span-21-8><a id=__codelineno-21-8 name=__codelineno-21-8 href=#__codelineno-21-8></a>              &#39;vector database&#39;,
</span><span id=__span-21-9><a id=__codelineno-21-9 name=__codelineno-21-9 href=#__codelineno-21-9></a>              &#39;Wikipedia articles&#39;,
</span><span id=__span-21-10><a id=__codelineno-21-10 name=__codelineno-21-10 href=#__codelineno-21-10></a>              &#39;information retrieval&#39;],
</span><span id=__span-21-11><a id=__codelineno-21-11 name=__codelineno-21-11 href=#__codelineno-21-11></a> &#39;summary&#39;: &#39;The simplest implementation of Retrieval-Augmented Generation &#39;
</span><span id=__span-21-12><a id=__codelineno-21-12 name=__codelineno-21-12 href=#__codelineno-21-12></a>            &#39;(RAG) involves embedding a user query and conducting a single &#39;
</span><span id=__span-21-13><a id=__codelineno-21-13 name=__codelineno-21-13 href=#__codelineno-21-13></a>            &#39;embedding search in a vector database, like a vector store of &#39;
</span><span id=__span-21-14><a id=__codelineno-21-14 name=__codelineno-21-14 href=#__codelineno-21-14></a>            &#39;Wikipedia articles, to retrieve relevant information. This method &#39;
</span><span id=__span-21-15><a id=__codelineno-21-15 name=__codelineno-21-15 href=#__codelineno-21-15></a>            &#39;may not be ideal for complex queries or varied data sources.&#39;,
</span><span id=__span-21-16><a id=__codelineno-21-16 name=__codelineno-21-16 href=#__codelineno-21-16></a> &#39;topic&#39;: &#39;Simple RAG&#39;}
</span><span id=__span-21-17><a id=__codelineno-21-17 name=__codelineno-21-17 href=#__codelineno-21-17></a>{&#39;hypothetical_questions&#39;: [&#39;What are the drawbacks of using simple RAG &#39;
</span><span id=__span-21-18><a id=__codelineno-21-18 name=__codelineno-21-18 href=#__codelineno-21-18></a>                            &#39;systems?&#39;,
</span><span id=__span-21-19><a id=__codelineno-21-19 name=__codelineno-21-19 href=#__codelineno-21-19></a>                            &#39;How does query-document mismatch affect the &#39;
</span><span id=__span-21-20><a id=__codelineno-21-20 name=__codelineno-21-20 href=#__codelineno-21-20></a>                            &#39;performance of RAG?&#39;,
</span><span id=__span-21-21><a id=__codelineno-21-21 name=__codelineno-21-21 href=#__codelineno-21-21></a>                            &#39;Why is a monolithic search backend a limitation &#39;
</span><span id=__span-21-22><a id=__codelineno-21-22 name=__codelineno-21-22 href=#__codelineno-21-22></a>                            &#39;for RAG?&#39;],
</span><span id=__span-21-23><a id=__codelineno-21-23 name=__codelineno-21-23 href=#__codelineno-21-23></a> &#39;keywords&#39;: [&#39;limitations&#39;,
</span><span id=__span-21-24><a id=__codelineno-21-24 name=__codelineno-21-24 href=#__codelineno-21-24></a>              &#39;query-document mismatch&#39;,
</span><span id=__span-21-25><a id=__codelineno-21-25 name=__codelineno-21-25 href=#__codelineno-21-25></a>              &#39;simple RAG&#39;,
</span><span id=__span-21-26><a id=__codelineno-21-26 name=__codelineno-21-26 href=#__codelineno-21-26></a>              &#39;monolithic search backend&#39;,
</span><span id=__span-21-27><a id=__codelineno-21-27 name=__codelineno-21-27 href=#__codelineno-21-27></a>              &#39;text search&#39;,
</span><span id=__span-21-28><a id=__codelineno-21-28 name=__codelineno-21-28 href=#__codelineno-21-28></a>              &#39;planning ability&#39;,
</span><span id=__span-21-29><a id=__codelineno-21-29 name=__codelineno-21-29 href=#__codelineno-21-29></a>              &#39;contextual information&#39;],
</span><span id=__span-21-30><a id=__codelineno-21-30 name=__codelineno-21-30 href=#__codelineno-21-30></a> &#39;summary&#39;: &#39;Key limitations of the simple RAG include query-document &#39;
</span><span id=__span-21-31><a id=__codelineno-21-31 name=__codelineno-21-31 href=#__codelineno-21-31></a>            &#39;mismatch, reliance on a single search backend, constraints of &#39;
</span><span id=__span-21-32><a id=__codelineno-21-32 name=__codelineno-21-32 href=#__codelineno-21-32></a>            &#39;text search capabilities, and limited planning ability to &#39;
</span><span id=__span-21-33><a id=__codelineno-21-33 name=__codelineno-21-33 href=#__codelineno-21-33></a>            &#39;leverage contextual information. These issues can result in &#39;
</span><span id=__span-21-34><a id=__codelineno-21-34 name=__codelineno-21-34 href=#__codelineno-21-34></a>            &#39;suboptimal search outcomes and retrieval of irrelevant or broad &#39;
</span><span id=__span-21-35><a id=__codelineno-21-35 name=__codelineno-21-35 href=#__codelineno-21-35></a>            &#39;information.&#39;,
</span><span id=__span-21-36><a id=__codelineno-21-36 name=__codelineno-21-36 href=#__codelineno-21-36></a> &#39;topic&#39;: &#39;Limitations of Simple RAG&#39;}
</span></code></pre></div> <p>Now you can imagine if you were to embed the summaries, hypothetical questions, and keywords in a vector database (i.e. in the metadata fields of a vector database), you can then use a vector search to find the best matching document for a given query. What you'll find is that the results are much better than if you were to just embed the text chunk!</p> <h3 id=retrieval><a class=toclink href=../../2024/08/01/query-understanding/#retrieval>Retrieval</a></h3> <p>Generally, we can use hybrid search (keyword search and embedding search in a single extraction material) together, but we must be careful about how to organize hybrid search. For example, if the HyDE question is not correct, we must reduce the weight of the HyDE question. The organization of hybrid search must be tuned for your specific project.If you are confused about retrieval, you can refer to this link...</p> <p>But the key to retrieval is providing the proper query. How do you generate the proper query? Let's find out in the next chapter.</p> <h3 id=query-understanding_1><a class=toclink href=../../2024/08/01/query-understanding/#query-understanding_1>Query understanding</a></h3> <h4 id=what-is-query-rewriting><a class=toclink href=../../2024/08/01/query-understanding/#what-is-query-rewriting>What is Query Rewriting?</a></h4> <p>Simply put, query rewriting means we will rewrite the user query in our own words, that our RAG app will know best how to answer. Instead of just doing retrieve-then-read, our app will do a rewrite-retrieve-read approach.</p> <p>We use a Generative AI model to rewrite the question. This model be a large model, like (or the same as) the one we use to answer the question in the final step. Or it can also be a smaller model, specially trained to perform this task.</p> <p>Also, query rewriting can take many different forms depending on the needs of the app. Most of the time, basic query rewriting will be enough. But, depending on the complexity of the questions we need to answer, we might need more advanced techniques like HyDE, multi-querying or step-back questions. More information on those in the following section.</p> <h4 id=why-does-it-work><a class=toclink href=../../2024/08/01/query-understanding/#why-does-it-work>Why does it work?</a></h4> <p>Query Rewriting usually gives better performance in any RAG app that is knowledge intensive. This is because RAG applications are sensitive to the phrasing and specific keywords of the query. Paraphrasing this query is helpful in the following scenarios:</p> <ol> <li>It restructures oddly written questions so they can be better understood by our system.</li> <li>It erases context given by the user which is irrelevant to the query.</li> <li>It can introduce common keywords, which will give it a better chance of matching up with the correct context.</li> <li>It can split complex questions into different sub.questions, which can be more easily responded separately, each with their corresponding context.</li> <li>It can answer question that require multiple levels of thinking by generating a step-back question, which is a higher-level concept question to the one from the user. It then uses both the original and the step-back question to retrieve context.</li> <li>It can use more advanced query rewriting techniques like HyDE to generate hypothetical documents to answer the question. These hypothetical documents will better capture the intent of the question and match up with the embeddings that contain the answer in the vector DB.</li> </ol> <h4 id=general-strategies-of-query-rewriting><a class=toclink href=../../2024/08/01/query-understanding/#general-strategies-of-query-rewriting>General strategies of query rewriting</a></h4> <p>Here are some key examples and use cases for various query rewriting techniques in RAG systems:</p> <p><strong>Hypothetical Document Embeddings (HyDE)</strong></p> <p>HyDE generates hypothetical documents based on the query to improve retrieval[1][2]. The process works as follows:</p> <ol> <li>An LLM generates a hypothetical document answering the query</li> <li>This document is encoded into a vector</li> <li>The vector is used for retrieval instead of the original query vector</li> </ol> <p>For example, given the query "What are the effects of climate change?", HyDE might generate a hypothetical document like:</p> <p>"Climate change has wide-ranging effects on the environment, including rising sea levels, more frequent extreme weather events, and shifts in plant and animal ranges. It impacts agriculture, water resources, human health, and ecosystems globally."</p> <p>This hypothetical document is then encoded and used for retrieval, potentially improving results compared to using the original short query[1].</p> <p><strong>Step-Back Prompting</strong></p> <p>Step-back prompting generates broader, more generic queries from a specific query[3]. For example:</p> <p>Original query: "How do I change a flat tire on a 2015 Toyota Camry?" Step-back query: "What are the general steps for changing a flat tire on a car?"</p> <p>This broader query may retrieve more relevant general information about tire changing that can then be applied to the specific case.</p> <p><strong>Query2Doc</strong></p> <p>Query2Doc generates pseudo-documents to expand and clarify the query[2]. Unlike HyDE, which assumes a direct answer, Query2Doc creates a document that provides context around the query. For example:</p> <p>Query: "What are the health benefits of turmeric?" Generated pseudo-document: "Turmeric is a spice commonly used in Indian cuisine. It has been studied for potential health benefits. Some areas of interest include its anti-inflammatory properties, antioxidant effects, and possible impacts on brain function and heart health."</p> <p>This pseudo-document is then used for retrieval, potentially capturing a wider range of relevant information.</p> <p><strong>Multi-querying / Sub-queries</strong></p> <p>This technique breaks down complex queries into multiple simpler sub-queries[3]. For example:</p> <p>Original query: "Compare the economic policies of FDR and Reagan" Sub-queries:</p> <ol> <li>"What were the main economic policies of Franklin D. Roosevelt?"</li> <li>"What were the key economic policies of Ronald Reagan?"</li> <li>"How did FDR's economic approach differ from Reagan's?"</li> </ol> <p>By breaking down the complex query, the system can retrieve more specific and relevant information for each aspect of the question.</p> <p>These techniques can significantly improve retrieval performance in RAG systems, leading to more accurate and comprehensive answers. The choice of technique depends on the specific use case, query complexity, and the nature of the information being retrieved.</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-22-1><a id=__codelineno-22-1 name=__codelineno-22-1 href=#__codelineno-22-1></a><span class=kn>from</span> <span class=nn>langchain.llms</span> <span class=kn>import</span> <span class=n>OpenAI</span>
</span><span id=__span-22-2><a id=__codelineno-22-2 name=__codelineno-22-2 href=#__codelineno-22-2></a><span class=kn>from</span> <span class=nn>langchain.prompts</span> <span class=kn>import</span> <span class=n>PromptTemplate</span>
</span><span id=__span-22-3><a id=__codelineno-22-3 name=__codelineno-22-3 href=#__codelineno-22-3></a><span class=kn>from</span> <span class=nn>langchain.chains</span> <span class=kn>import</span> <span class=n>LLMChain</span>
</span><span id=__span-22-4><a id=__codelineno-22-4 name=__codelineno-22-4 href=#__codelineno-22-4></a><span class=kn>from</span> <span class=nn>langchain.embeddings</span> <span class=kn>import</span> <span class=n>OpenAIEmbeddings</span>
</span><span id=__span-22-5><a id=__codelineno-22-5 name=__codelineno-22-5 href=#__codelineno-22-5></a><span class=kn>from</span> <span class=nn>langchain.text_splitter</span> <span class=kn>import</span> <span class=n>CharacterTextSplitter</span>
</span><span id=__span-22-6><a id=__codelineno-22-6 name=__codelineno-22-6 href=#__codelineno-22-6></a><span class=kn>from</span> <span class=nn>langchain.vectorstores</span> <span class=kn>import</span> <span class=n>FAISS</span>
</span><span id=__span-22-7><a id=__codelineno-22-7 name=__codelineno-22-7 href=#__codelineno-22-7></a><span class=kn>from</span> <span class=nn>langchain.docstore.document</span> <span class=kn>import</span> <span class=n>Document</span>
</span><span id=__span-22-8><a id=__codelineno-22-8 name=__codelineno-22-8 href=#__codelineno-22-8></a>
</span><span id=__span-22-9><a id=__codelineno-22-9 name=__codelineno-22-9 href=#__codelineno-22-9></a><span class=c1># Initialize LLM and embeddings</span>
</span><span id=__span-22-10><a id=__codelineno-22-10 name=__codelineno-22-10 href=#__codelineno-22-10></a><span class=n>llm</span> <span class=o>=</span> <span class=n>OpenAI</span><span class=p>(</span><span class=n>temperature</span><span class=o>=</span><span class=mf>0.7</span><span class=p>)</span>
</span><span id=__span-22-11><a id=__codelineno-22-11 name=__codelineno-22-11 href=#__codelineno-22-11></a><span class=n>embeddings</span> <span class=o>=</span> <span class=n>OpenAIEmbeddings</span><span class=p>()</span>
</span><span id=__span-22-12><a id=__codelineno-22-12 name=__codelineno-22-12 href=#__codelineno-22-12></a>
</span><span id=__span-22-13><a id=__codelineno-22-13 name=__codelineno-22-13 href=#__codelineno-22-13></a><span class=c1># 1. Hypothetical Document Embeddings (HyDE)</span>
</span><span id=__span-22-14><a id=__codelineno-22-14 name=__codelineno-22-14 href=#__codelineno-22-14></a><span class=n>hyde_prompt</span> <span class=o>=</span> <span class=n>PromptTemplate</span><span class=p>(</span>
</span><span id=__span-22-15><a id=__codelineno-22-15 name=__codelineno-22-15 href=#__codelineno-22-15></a>    <span class=n>input_variables</span><span class=o>=</span><span class=p>[</span><span class=s2>&quot;query&quot;</span><span class=p>],</span>
</span><span id=__span-22-16><a id=__codelineno-22-16 name=__codelineno-22-16 href=#__codelineno-22-16></a>    <span class=n>template</span><span class=o>=</span><span class=s2>&quot;Generate a detailed answer for the following question:</span><span class=se>\n</span><span class=si>{query}</span><span class=se>\n\n</span><span class=s2>Answer:&quot;</span>
</span><span id=__span-22-17><a id=__codelineno-22-17 name=__codelineno-22-17 href=#__codelineno-22-17></a><span class=p>)</span>
</span><span id=__span-22-18><a id=__codelineno-22-18 name=__codelineno-22-18 href=#__codelineno-22-18></a>
</span><span id=__span-22-19><a id=__codelineno-22-19 name=__codelineno-22-19 href=#__codelineno-22-19></a><span class=n>hyde_chain</span> <span class=o>=</span> <span class=n>LLMChain</span><span class=p>(</span><span class=n>llm</span><span class=o>=</span><span class=n>llm</span><span class=p>,</span> <span class=n>prompt</span><span class=o>=</span><span class=n>hyde_prompt</span><span class=p>)</span>
</span><span id=__span-22-20><a id=__codelineno-22-20 name=__codelineno-22-20 href=#__codelineno-22-20></a>
</span><span id=__span-22-21><a id=__codelineno-22-21 name=__codelineno-22-21 href=#__codelineno-22-21></a><span class=k>def</span> <span class=nf>hyde</span><span class=p>(</span><span class=n>query</span><span class=p>):</span>
</span><span id=__span-22-22><a id=__codelineno-22-22 name=__codelineno-22-22 href=#__codelineno-22-22></a>    <span class=n>hypothetical_doc</span> <span class=o>=</span> <span class=n>hyde_chain</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>query</span><span class=p>)</span>
</span><span id=__span-22-23><a id=__codelineno-22-23 name=__codelineno-22-23 href=#__codelineno-22-23></a>    <span class=n>doc_embedding</span> <span class=o>=</span> <span class=n>embeddings</span><span class=o>.</span><span class=n>embed_query</span><span class=p>(</span><span class=n>hypothetical_doc</span><span class=p>)</span>
</span><span id=__span-22-24><a id=__codelineno-22-24 name=__codelineno-22-24 href=#__codelineno-22-24></a>    <span class=k>return</span> <span class=n>doc_embedding</span>
</span><span id=__span-22-25><a id=__codelineno-22-25 name=__codelineno-22-25 href=#__codelineno-22-25></a>
</span><span id=__span-22-26><a id=__codelineno-22-26 name=__codelineno-22-26 href=#__codelineno-22-26></a><span class=c1># Usage</span>
</span><span id=__span-22-27><a id=__codelineno-22-27 name=__codelineno-22-27 href=#__codelineno-22-27></a><span class=n>query</span> <span class=o>=</span> <span class=s2>&quot;What are the effects of climate change?&quot;</span>
</span><span id=__span-22-28><a id=__codelineno-22-28 name=__codelineno-22-28 href=#__codelineno-22-28></a><span class=n>hyde_embedding</span> <span class=o>=</span> <span class=n>hyde</span><span class=p>(</span><span class=n>query</span><span class=p>)</span>
</span><span id=__span-22-29><a id=__codelineno-22-29 name=__codelineno-22-29 href=#__codelineno-22-29></a>
</span><span id=__span-22-30><a id=__codelineno-22-30 name=__codelineno-22-30 href=#__codelineno-22-30></a><span class=c1># 2. Step-Back Prompting</span>
</span><span id=__span-22-31><a id=__codelineno-22-31 name=__codelineno-22-31 href=#__codelineno-22-31></a><span class=n>step_back_prompt</span> <span class=o>=</span> <span class=n>PromptTemplate</span><span class=p>(</span>
</span><span id=__span-22-32><a id=__codelineno-22-32 name=__codelineno-22-32 href=#__codelineno-22-32></a>    <span class=n>input_variables</span><span class=o>=</span><span class=p>[</span><span class=s2>&quot;query&quot;</span><span class=p>],</span>
</span><span id=__span-22-33><a id=__codelineno-22-33 name=__codelineno-22-33 href=#__codelineno-22-33></a>    <span class=n>template</span><span class=o>=</span><span class=s2>&quot;Generate a more general version of this specific query:</span><span class=se>\n</span><span class=si>{query}</span><span class=se>\n\n</span><span class=s2>General query:&quot;</span>
</span><span id=__span-22-34><a id=__codelineno-22-34 name=__codelineno-22-34 href=#__codelineno-22-34></a><span class=p>)</span>
</span><span id=__span-22-35><a id=__codelineno-22-35 name=__codelineno-22-35 href=#__codelineno-22-35></a>
</span><span id=__span-22-36><a id=__codelineno-22-36 name=__codelineno-22-36 href=#__codelineno-22-36></a><span class=n>step_back_chain</span> <span class=o>=</span> <span class=n>LLMChain</span><span class=p>(</span><span class=n>llm</span><span class=o>=</span><span class=n>llm</span><span class=p>,</span> <span class=n>prompt</span><span class=o>=</span><span class=n>step_back_prompt</span><span class=p>)</span>
</span><span id=__span-22-37><a id=__codelineno-22-37 name=__codelineno-22-37 href=#__codelineno-22-37></a>
</span><span id=__span-22-38><a id=__codelineno-22-38 name=__codelineno-22-38 href=#__codelineno-22-38></a><span class=k>def</span> <span class=nf>step_back</span><span class=p>(</span><span class=n>query</span><span class=p>):</span>
</span><span id=__span-22-39><a id=__codelineno-22-39 name=__codelineno-22-39 href=#__codelineno-22-39></a>    <span class=n>general_query</span> <span class=o>=</span> <span class=n>step_back_chain</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>query</span><span class=p>)</span>
</span><span id=__span-22-40><a id=__codelineno-22-40 name=__codelineno-22-40 href=#__codelineno-22-40></a>    <span class=k>return</span> <span class=n>general_query</span>
</span><span id=__span-22-41><a id=__codelineno-22-41 name=__codelineno-22-41 href=#__codelineno-22-41></a>
</span><span id=__span-22-42><a id=__codelineno-22-42 name=__codelineno-22-42 href=#__codelineno-22-42></a><span class=c1># Usage</span>
</span><span id=__span-22-43><a id=__codelineno-22-43 name=__codelineno-22-43 href=#__codelineno-22-43></a><span class=n>specific_query</span> <span class=o>=</span> <span class=s2>&quot;How do I change a flat tire on a 2015 Toyota Camry?&quot;</span>
</span><span id=__span-22-44><a id=__codelineno-22-44 name=__codelineno-22-44 href=#__codelineno-22-44></a><span class=n>general_query</span> <span class=o>=</span> <span class=n>step_back</span><span class=p>(</span><span class=n>specific_query</span><span class=p>)</span>
</span><span id=__span-22-45><a id=__codelineno-22-45 name=__codelineno-22-45 href=#__codelineno-22-45></a>
</span><span id=__span-22-46><a id=__codelineno-22-46 name=__codelineno-22-46 href=#__codelineno-22-46></a><span class=c1># 3. Query2Doc</span>
</span><span id=__span-22-47><a id=__codelineno-22-47 name=__codelineno-22-47 href=#__codelineno-22-47></a><span class=n>query2doc_prompt</span> <span class=o>=</span> <span class=n>PromptTemplate</span><span class=p>(</span>
</span><span id=__span-22-48><a id=__codelineno-22-48 name=__codelineno-22-48 href=#__codelineno-22-48></a>    <span class=n>input_variables</span><span class=o>=</span><span class=p>[</span><span class=s2>&quot;query&quot;</span><span class=p>],</span>
</span><span id=__span-22-49><a id=__codelineno-22-49 name=__codelineno-22-49 href=#__codelineno-22-49></a>    <span class=n>template</span><span class=o>=</span><span class=s2>&quot;Generate a short document providing context for this query:</span><span class=se>\n</span><span class=si>{query}</span><span class=se>\n\n</span><span class=s2>Context document:&quot;</span>
</span><span id=__span-22-50><a id=__codelineno-22-50 name=__codelineno-22-50 href=#__codelineno-22-50></a><span class=p>)</span>
</span><span id=__span-22-51><a id=__codelineno-22-51 name=__codelineno-22-51 href=#__codelineno-22-51></a>
</span><span id=__span-22-52><a id=__codelineno-22-52 name=__codelineno-22-52 href=#__codelineno-22-52></a><span class=n>query2doc_chain</span> <span class=o>=</span> <span class=n>LLMChain</span><span class=p>(</span><span class=n>llm</span><span class=o>=</span><span class=n>llm</span><span class=p>,</span> <span class=n>prompt</span><span class=o>=</span><span class=n>query2doc_prompt</span><span class=p>)</span>
</span><span id=__span-22-53><a id=__codelineno-22-53 name=__codelineno-22-53 href=#__codelineno-22-53></a>
</span><span id=__span-22-54><a id=__codelineno-22-54 name=__codelineno-22-54 href=#__codelineno-22-54></a><span class=k>def</span> <span class=nf>query2doc</span><span class=p>(</span><span class=n>query</span><span class=p>):</span>
</span><span id=__span-22-55><a id=__codelineno-22-55 name=__codelineno-22-55 href=#__codelineno-22-55></a>    <span class=n>pseudo_doc</span> <span class=o>=</span> <span class=n>query2doc_chain</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>query</span><span class=p>)</span>
</span><span id=__span-22-56><a id=__codelineno-22-56 name=__codelineno-22-56 href=#__codelineno-22-56></a>    <span class=k>return</span> <span class=n>pseudo_doc</span>
</span><span id=__span-22-57><a id=__codelineno-22-57 name=__codelineno-22-57 href=#__codelineno-22-57></a>
</span><span id=__span-22-58><a id=__codelineno-22-58 name=__codelineno-22-58 href=#__codelineno-22-58></a><span class=c1># Usage</span>
</span><span id=__span-22-59><a id=__codelineno-22-59 name=__codelineno-22-59 href=#__codelineno-22-59></a><span class=n>query</span> <span class=o>=</span> <span class=s2>&quot;What are the health benefits of turmeric?&quot;</span>
</span><span id=__span-22-60><a id=__codelineno-22-60 name=__codelineno-22-60 href=#__codelineno-22-60></a><span class=n>pseudo_doc</span> <span class=o>=</span> <span class=n>query2doc</span><span class=p>(</span><span class=n>query</span><span class=p>)</span>
</span><span id=__span-22-61><a id=__codelineno-22-61 name=__codelineno-22-61 href=#__codelineno-22-61></a>
</span><span id=__span-22-62><a id=__codelineno-22-62 name=__codelineno-22-62 href=#__codelineno-22-62></a><span class=c1># 4. Multi-querying / Sub-queries</span>
</span><span id=__span-22-63><a id=__codelineno-22-63 name=__codelineno-22-63 href=#__codelineno-22-63></a><span class=n>multi_query_prompt</span> <span class=o>=</span> <span class=n>PromptTemplate</span><span class=p>(</span>
</span><span id=__span-22-64><a id=__codelineno-22-64 name=__codelineno-22-64 href=#__codelineno-22-64></a>    <span class=n>input_variables</span><span class=o>=</span><span class=p>[</span><span class=s2>&quot;query&quot;</span><span class=p>],</span>
</span><span id=__span-22-65><a id=__codelineno-22-65 name=__codelineno-22-65 href=#__codelineno-22-65></a>    <span class=n>template</span><span class=o>=</span><span class=s2>&quot;Break down this complex query into 3-5 simpler sub-queries:</span><span class=se>\n</span><span class=si>{query}</span><span class=se>\n\n</span><span class=s2>Sub-queries:&quot;</span>
</span><span id=__span-22-66><a id=__codelineno-22-66 name=__codelineno-22-66 href=#__codelineno-22-66></a><span class=p>)</span>
</span><span id=__span-22-67><a id=__codelineno-22-67 name=__codelineno-22-67 href=#__codelineno-22-67></a>
</span><span id=__span-22-68><a id=__codelineno-22-68 name=__codelineno-22-68 href=#__codelineno-22-68></a><span class=n>multi_query_chain</span> <span class=o>=</span> <span class=n>LLMChain</span><span class=p>(</span><span class=n>llm</span><span class=o>=</span><span class=n>llm</span><span class=p>,</span> <span class=n>prompt</span><span class=o>=</span><span class=n>multi_query_prompt</span><span class=p>)</span>
</span><span id=__span-22-69><a id=__codelineno-22-69 name=__codelineno-22-69 href=#__codelineno-22-69></a>
</span><span id=__span-22-70><a id=__codelineno-22-70 name=__codelineno-22-70 href=#__codelineno-22-70></a><span class=k>def</span> <span class=nf>multi_query</span><span class=p>(</span><span class=n>query</span><span class=p>):</span>
</span><span id=__span-22-71><a id=__codelineno-22-71 name=__codelineno-22-71 href=#__codelineno-22-71></a>    <span class=n>sub_queries_text</span> <span class=o>=</span> <span class=n>multi_query_chain</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>query</span><span class=p>)</span>
</span><span id=__span-22-72><a id=__codelineno-22-72 name=__codelineno-22-72 href=#__codelineno-22-72></a>    <span class=n>sub_queries</span> <span class=o>=</span> <span class=n>sub_queries_text</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>
</span><span id=__span-22-73><a id=__codelineno-22-73 name=__codelineno-22-73 href=#__codelineno-22-73></a>    <span class=k>return</span> <span class=p>[</span><span class=n>q</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span> <span class=k>for</span> <span class=n>q</span> <span class=ow>in</span> <span class=n>sub_queries</span> <span class=k>if</span> <span class=n>q</span><span class=o>.</span><span class=n>strip</span><span class=p>()]</span>
</span><span id=__span-22-74><a id=__codelineno-22-74 name=__codelineno-22-74 href=#__codelineno-22-74></a>
</span><span id=__span-22-75><a id=__codelineno-22-75 name=__codelineno-22-75 href=#__codelineno-22-75></a><span class=c1># Usage</span>
</span><span id=__span-22-76><a id=__codelineno-22-76 name=__codelineno-22-76 href=#__codelineno-22-76></a><span class=n>complex_query</span> <span class=o>=</span> <span class=s2>&quot;Compare the economic policies of FDR and Reagan&quot;</span>
</span><span id=__span-22-77><a id=__codelineno-22-77 name=__codelineno-22-77 href=#__codelineno-22-77></a><span class=n>sub_queries</span> <span class=o>=</span> <span class=n>multi_query</span><span class=p>(</span><span class=n>complex_query</span><span class=p>)</span>
</span><span id=__span-22-78><a id=__codelineno-22-78 name=__codelineno-22-78 href=#__codelineno-22-78></a>
</span><span id=__span-22-79><a id=__codelineno-22-79 name=__codelineno-22-79 href=#__codelineno-22-79></a><span class=c1># Example of using these in a RAG pipeline</span>
</span><span id=__span-22-80><a id=__codelineno-22-80 name=__codelineno-22-80 href=#__codelineno-22-80></a><span class=k>def</span> <span class=nf>rag_pipeline</span><span class=p>(</span><span class=n>query</span><span class=p>,</span> <span class=n>documents</span><span class=p>):</span>
</span><span id=__span-22-81><a id=__codelineno-22-81 name=__codelineno-22-81 href=#__codelineno-22-81></a>    <span class=c1># Create vector store</span>
</span><span id=__span-22-82><a id=__codelineno-22-82 name=__codelineno-22-82 href=#__codelineno-22-82></a>    <span class=n>text_splitter</span> <span class=o>=</span> <span class=n>CharacterTextSplitter</span><span class=p>(</span><span class=n>chunk_size</span><span class=o>=</span><span class=mi>1000</span><span class=p>,</span> <span class=n>chunk_overlap</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-22-83><a id=__codelineno-22-83 name=__codelineno-22-83 href=#__codelineno-22-83></a>    <span class=n>texts</span> <span class=o>=</span> <span class=n>text_splitter</span><span class=o>.</span><span class=n>split_documents</span><span class=p>(</span><span class=n>documents</span><span class=p>)</span>
</span><span id=__span-22-84><a id=__codelineno-22-84 name=__codelineno-22-84 href=#__codelineno-22-84></a>    <span class=n>docsearch</span> <span class=o>=</span> <span class=n>FAISS</span><span class=o>.</span><span class=n>from_documents</span><span class=p>(</span><span class=n>texts</span><span class=p>,</span> <span class=n>embeddings</span><span class=p>)</span>
</span><span id=__span-22-85><a id=__codelineno-22-85 name=__codelineno-22-85 href=#__codelineno-22-85></a>
</span><span id=__span-22-86><a id=__codelineno-22-86 name=__codelineno-22-86 href=#__codelineno-22-86></a>    <span class=c1># Query rewriting</span>
</span><span id=__span-22-87><a id=__codelineno-22-87 name=__codelineno-22-87 href=#__codelineno-22-87></a>    <span class=n>hyde_emb</span> <span class=o>=</span> <span class=n>hyde</span><span class=p>(</span><span class=n>query</span><span class=p>)</span>
</span><span id=__span-22-88><a id=__codelineno-22-88 name=__codelineno-22-88 href=#__codelineno-22-88></a>    <span class=n>general_query</span> <span class=o>=</span> <span class=n>step_back</span><span class=p>(</span><span class=n>query</span><span class=p>)</span>
</span><span id=__span-22-89><a id=__codelineno-22-89 name=__codelineno-22-89 href=#__codelineno-22-89></a>    <span class=n>pseudo_doc</span> <span class=o>=</span> <span class=n>query2doc</span><span class=p>(</span><span class=n>query</span><span class=p>)</span>
</span><span id=__span-22-90><a id=__codelineno-22-90 name=__codelineno-22-90 href=#__codelineno-22-90></a>    <span class=n>sub_queries</span> <span class=o>=</span> <span class=n>multi_query</span><span class=p>(</span><span class=n>query</span><span class=p>)</span>
</span><span id=__span-22-91><a id=__codelineno-22-91 name=__codelineno-22-91 href=#__codelineno-22-91></a>
</span><span id=__span-22-92><a id=__codelineno-22-92 name=__codelineno-22-92 href=#__codelineno-22-92></a>    <span class=c1># Retrieve documents using various methods</span>
</span><span id=__span-22-93><a id=__codelineno-22-93 name=__codelineno-22-93 href=#__codelineno-22-93></a>    <span class=n>hyde_docs</span> <span class=o>=</span> <span class=n>docsearch</span><span class=o>.</span><span class=n>similarity_search_by_vector</span><span class=p>(</span><span class=n>hyde_emb</span><span class=p>,</span> <span class=n>k</span><span class=o>=</span><span class=mi>2</span><span class=p>)</span>
</span><span id=__span-22-94><a id=__codelineno-22-94 name=__codelineno-22-94 href=#__codelineno-22-94></a>    <span class=n>general_docs</span> <span class=o>=</span> <span class=n>docsearch</span><span class=o>.</span><span class=n>similarity_search</span><span class=p>(</span><span class=n>general_query</span><span class=p>,</span> <span class=n>k</span><span class=o>=</span><span class=mi>2</span><span class=p>)</span>
</span><span id=__span-22-95><a id=__codelineno-22-95 name=__codelineno-22-95 href=#__codelineno-22-95></a>    <span class=n>pseudo_docs</span> <span class=o>=</span> <span class=n>docsearch</span><span class=o>.</span><span class=n>similarity_search</span><span class=p>(</span><span class=n>pseudo_doc</span><span class=p>,</span> <span class=n>k</span><span class=o>=</span><span class=mi>2</span><span class=p>)</span>
</span><span id=__span-22-96><a id=__codelineno-22-96 name=__codelineno-22-96 href=#__codelineno-22-96></a>    <span class=n>sub_query_docs</span> <span class=o>=</span> <span class=p>[</span><span class=n>doc</span> <span class=k>for</span> <span class=n>sq</span> <span class=ow>in</span> <span class=n>sub_queries</span> <span class=k>for</span> <span class=n>doc</span> <span class=ow>in</span> <span class=n>docsearch</span><span class=o>.</span><span class=n>similarity_search</span><span class=p>(</span><span class=n>sq</span><span class=p>,</span> <span class=n>k</span><span class=o>=</span><span class=mi>1</span><span class=p>)]</span>
</span><span id=__span-22-97><a id=__codelineno-22-97 name=__codelineno-22-97 href=#__codelineno-22-97></a>
</span><span id=__span-22-98><a id=__codelineno-22-98 name=__codelineno-22-98 href=#__codelineno-22-98></a>    <span class=c1># Combine and deduplicate results</span>
</span><span id=__span-22-99><a id=__codelineno-22-99 name=__codelineno-22-99 href=#__codelineno-22-99></a>    <span class=n>all_docs</span> <span class=o>=</span> <span class=n>hyde_docs</span> <span class=o>+</span> <span class=n>general_docs</span> <span class=o>+</span> <span class=n>pseudo_docs</span> <span class=o>+</span> <span class=n>sub_query_docs</span>
</span><span id=__span-22-100><a id=__codelineno-22-100 name=__codelineno-22-100 href=#__codelineno-22-100></a>    <span class=n>unique_docs</span> <span class=o>=</span> <span class=nb>list</span><span class=p>({</span><span class=n>doc</span><span class=o>.</span><span class=n>page_content</span><span class=p>:</span> <span class=n>doc</span> <span class=k>for</span> <span class=n>doc</span> <span class=ow>in</span> <span class=n>all_docs</span><span class=p>}</span><span class=o>.</span><span class=n>values</span><span class=p>())</span>
</span><span id=__span-22-101><a id=__codelineno-22-101 name=__codelineno-22-101 href=#__codelineno-22-101></a>
</span><span id=__span-22-102><a id=__codelineno-22-102 name=__codelineno-22-102 href=#__codelineno-22-102></a>    <span class=c1># Here you would typically pass these documents to your LLM for final answer generation</span>
</span><span id=__span-22-103><a id=__codelineno-22-103 name=__codelineno-22-103 href=#__codelineno-22-103></a>    <span class=k>return</span> <span class=n>unique_docs</span>
</span><span id=__span-22-104><a id=__codelineno-22-104 name=__codelineno-22-104 href=#__codelineno-22-104></a>
</span><span id=__span-22-105><a id=__codelineno-22-105 name=__codelineno-22-105 href=#__codelineno-22-105></a><span class=c1># Usage</span>
</span><span id=__span-22-106><a id=__codelineno-22-106 name=__codelineno-22-106 href=#__codelineno-22-106></a><span class=n>documents</span> <span class=o>=</span> <span class=p>[</span><span class=n>Document</span><span class=p>(</span><span class=n>page_content</span><span class=o>=</span><span class=sa>f</span><span class=s2>&quot;Document </span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>10</span><span class=p>)]</span>  <span class=c1># Example documents</span>
</span><span id=__span-22-107><a id=__codelineno-22-107 name=__codelineno-22-107 href=#__codelineno-22-107></a><span class=n>query</span> <span class=o>=</span> <span class=s2>&quot;What are the long-term economic impacts of climate change?&quot;</span>
</span><span id=__span-22-108><a id=__codelineno-22-108 name=__codelineno-22-108 href=#__codelineno-22-108></a><span class=n>relevant_docs</span> <span class=o>=</span> <span class=n>rag_pipeline</span><span class=p>(</span><span class=n>query</span><span class=p>,</span> <span class=n>documents</span><span class=p>)</span>
</span></code></pre></div> <h4 id=understanding-recent-queries-to-add-temporal-context><a class=toclink href=../../2024/08/01/query-understanding/#understanding-recent-queries-to-add-temporal-context><strong>Understanding 'recent queries' to add temporal context</strong></a></h4> <p>One common application of using structured outputs for query understanding is to identify the intent of a user's query. In this example we're going to use a simple schema to seperately process the query to add additional temporal context.</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-23-1><a id=__codelineno-23-1 name=__codelineno-23-1 href=#__codelineno-23-1></a><span class=kn>from</span> <span class=nn>datetime</span> <span class=kn>import</span> <span class=n>date</span>
</span><span id=__span-23-2><a id=__codelineno-23-2 name=__codelineno-23-2 href=#__codelineno-23-2></a>
</span><span id=__span-23-3><a id=__codelineno-23-3 name=__codelineno-23-3 href=#__codelineno-23-3></a><span class=k>class</span> <span class=nc>DateRange</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span><span id=__span-23-4><a id=__codelineno-23-4 name=__codelineno-23-4 href=#__codelineno-23-4></a>    <span class=n>start</span><span class=p>:</span> <span class=n>date</span>
</span><span id=__span-23-5><a id=__codelineno-23-5 name=__codelineno-23-5 href=#__codelineno-23-5></a>    <span class=n>end</span><span class=p>:</span> <span class=n>date</span>
</span><span id=__span-23-6><a id=__codelineno-23-6 name=__codelineno-23-6 href=#__codelineno-23-6></a>
</span><span id=__span-23-7><a id=__codelineno-23-7 name=__codelineno-23-7 href=#__codelineno-23-7></a><span class=k>class</span> <span class=nc>Query</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span><span id=__span-23-8><a id=__codelineno-23-8 name=__codelineno-23-8 href=#__codelineno-23-8></a>    <span class=n>rewritten_query</span><span class=p>:</span> <span class=nb>str</span>
</span><span id=__span-23-9><a id=__codelineno-23-9 name=__codelineno-23-9 href=#__codelineno-23-9></a>    <span class=n>published_daterange</span><span class=p>:</span> <span class=n>DateRange</span>
</span></code></pre></div> <p>In this example, <code>DateRange</code> and <code>Query</code> are Pydantic models that structure the user's query with a date range and a list of domains to search within.</p> <p>These models <strong>restructure</strong> the user's query by including a rewritten query, a range of published dates, and a list of domains to search in.</p> <p>Using the new restructured query, we can apply this pattern to our function calls to obtain results that are optimized for our backend.</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-24-1><a id=__codelineno-24-1 name=__codelineno-24-1 href=#__codelineno-24-1></a><span class=k>def</span> <span class=nf>expand_query</span><span class=p>(</span><span class=n>q</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Query</span><span class=p>:</span>
</span><span id=__span-24-2><a id=__codelineno-24-2 name=__codelineno-24-2 href=#__codelineno-24-2></a>    <span class=k>return</span> <span class=n>client</span><span class=o>.</span><span class=n>chat</span><span class=o>.</span><span class=n>completions</span><span class=o>.</span><span class=n>create</span><span class=p>(</span>
</span><span id=__span-24-3><a id=__codelineno-24-3 name=__codelineno-24-3 href=#__codelineno-24-3></a>        <span class=n>model</span><span class=o>=</span><span class=s2>&quot;gpt-3.5-turbo&quot;</span><span class=p>,</span>
</span><span id=__span-24-4><a id=__codelineno-24-4 name=__codelineno-24-4 href=#__codelineno-24-4></a>        <span class=n>response_model</span><span class=o>=</span><span class=n>Query</span><span class=p>,</span>
</span><span id=__span-24-5><a id=__codelineno-24-5 name=__codelineno-24-5 href=#__codelineno-24-5></a>        <span class=n>messages</span><span class=o>=</span><span class=p>[</span>
</span><span id=__span-24-6><a id=__codelineno-24-6 name=__codelineno-24-6 href=#__codelineno-24-6></a>            <span class=p>{</span>
</span><span id=__span-24-7><a id=__codelineno-24-7 name=__codelineno-24-7 href=#__codelineno-24-7></a>                <span class=s2>&quot;role&quot;</span><span class=p>:</span> <span class=s2>&quot;system&quot;</span><span class=p>,</span>
</span><span id=__span-24-8><a id=__codelineno-24-8 name=__codelineno-24-8 href=#__codelineno-24-8></a>                <span class=s2>&quot;content&quot;</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&quot;You&#39;re a query understanding system for the Metafor Systems search engine. Today is </span><span class=si>{</span><span class=n>date</span><span class=o>.</span><span class=n>today</span><span class=p>()</span><span class=si>}</span><span class=s2>. Here are some tips: ...&quot;</span><span class=p>,</span>
</span><span id=__span-24-9><a id=__codelineno-24-9 name=__codelineno-24-9 href=#__codelineno-24-9></a>            <span class=p>},</span>
</span><span id=__span-24-10><a id=__codelineno-24-10 name=__codelineno-24-10 href=#__codelineno-24-10></a>            <span class=p>{</span><span class=s2>&quot;role&quot;</span><span class=p>:</span> <span class=s2>&quot;user&quot;</span><span class=p>,</span> <span class=s2>&quot;content&quot;</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&quot;query: </span><span class=si>{</span><span class=n>q</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>},</span>
</span><span id=__span-24-11><a id=__codelineno-24-11 name=__codelineno-24-11 href=#__codelineno-24-11></a>        <span class=p>],</span>
</span><span id=__span-24-12><a id=__codelineno-24-12 name=__codelineno-24-12 href=#__codelineno-24-12></a>    <span class=p>)</span>
</span><span id=__span-24-13><a id=__codelineno-24-13 name=__codelineno-24-13 href=#__codelineno-24-13></a>
</span><span id=__span-24-14><a id=__codelineno-24-14 name=__codelineno-24-14 href=#__codelineno-24-14></a><span class=n>query</span> <span class=o>=</span> <span class=n>expand_query</span><span class=p>(</span><span class=s2>&quot;What are some recent developments in AI?&quot;</span><span class=p>)</span>
</span><span id=__span-24-15><a id=__codelineno-24-15 name=__codelineno-24-15 href=#__codelineno-24-15></a><span class=n>query</span>
</span></code></pre></div> <div class="language-python highlight"><pre><span></span><code><span id=__span-25-1><a id=__codelineno-25-1 name=__codelineno-25-1 href=#__codelineno-25-1></a><span class=n>Query</span><span class=p>(</span><span class=n>rewritten_query</span><span class=o>=</span><span class=s1>&#39;Recent developments in artificial intelligence&#39;</span><span class=p>,</span> <span class=n>published_daterange</span><span class=o>=</span><span class=n>DateRange</span><span class=p>(</span><span class=n>start</span><span class=o>=</span><span class=n>datetime</span><span class=o>.</span><span class=n>date</span><span class=p>(</span><span class=mi>2024</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>),</span> <span class=n>end</span><span class=o>=</span><span class=n>datetime</span><span class=o>.</span><span class=n>date</span><span class=p>(</span><span class=mi>2024</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>31</span><span class=p>)))</span>
</span></code></pre></div> <p>This isn't just about adding some date ranges. We can even use some chain of thought prompting to generate tailored searches that are deeply integrated with our backend.</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-26-1><a id=__codelineno-26-1 name=__codelineno-26-1 href=#__codelineno-26-1></a><span class=k>class</span> <span class=nc>DateRange</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span><span id=__span-26-2><a id=__codelineno-26-2 name=__codelineno-26-2 href=#__codelineno-26-2></a>    <span class=n>chain_of_thought</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span>
</span><span id=__span-26-3><a id=__codelineno-26-3 name=__codelineno-26-3 href=#__codelineno-26-3></a>        <span class=n>description</span><span class=o>=</span><span class=s2>&quot;Think step by step to plan what is the best time range to search in&quot;</span>
</span><span id=__span-26-4><a id=__codelineno-26-4 name=__codelineno-26-4 href=#__codelineno-26-4></a>    <span class=p>)</span>
</span><span id=__span-26-5><a id=__codelineno-26-5 name=__codelineno-26-5 href=#__codelineno-26-5></a>    <span class=n>start</span><span class=p>:</span> <span class=n>date</span>
</span><span id=__span-26-6><a id=__codelineno-26-6 name=__codelineno-26-6 href=#__codelineno-26-6></a>    <span class=n>end</span><span class=p>:</span> <span class=n>date</span>
</span><span id=__span-26-7><a id=__codelineno-26-7 name=__codelineno-26-7 href=#__codelineno-26-7></a>
</span><span id=__span-26-8><a id=__codelineno-26-8 name=__codelineno-26-8 href=#__codelineno-26-8></a><span class=k>class</span> <span class=nc>Query</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span><span id=__span-26-9><a id=__codelineno-26-9 name=__codelineno-26-9 href=#__codelineno-26-9></a>    <span class=n>rewritten_query</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span>
</span><span id=__span-26-10><a id=__codelineno-26-10 name=__codelineno-26-10 href=#__codelineno-26-10></a>        <span class=n>description</span><span class=o>=</span><span class=s2>&quot;Rewrite the query to make it more specific&quot;</span>
</span><span id=__span-26-11><a id=__codelineno-26-11 name=__codelineno-26-11 href=#__codelineno-26-11></a>    <span class=p>)</span>
</span><span id=__span-26-12><a id=__codelineno-26-12 name=__codelineno-26-12 href=#__codelineno-26-12></a>    <span class=n>published_daterange</span><span class=p>:</span> <span class=n>DateRange</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span>
</span><span id=__span-26-13><a id=__codelineno-26-13 name=__codelineno-26-13 href=#__codelineno-26-13></a>        <span class=n>description</span><span class=o>=</span><span class=s2>&quot;Effective date range to search in&quot;</span>
</span><span id=__span-26-14><a id=__codelineno-26-14 name=__codelineno-26-14 href=#__codelineno-26-14></a>    <span class=p>)</span>
</span><span id=__span-26-15><a id=__codelineno-26-15 name=__codelineno-26-15 href=#__codelineno-26-15></a>
</span><span id=__span-26-16><a id=__codelineno-26-16 name=__codelineno-26-16 href=#__codelineno-26-16></a><span class=k>def</span> <span class=nf>expand_query</span><span class=p>(</span><span class=n>q</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Query</span><span class=p>:</span>
</span><span id=__span-26-17><a id=__codelineno-26-17 name=__codelineno-26-17 href=#__codelineno-26-17></a>    <span class=k>return</span> <span class=n>client</span><span class=o>.</span><span class=n>chat</span><span class=o>.</span><span class=n>completions</span><span class=o>.</span><span class=n>create</span><span class=p>(</span>
</span><span id=__span-26-18><a id=__codelineno-26-18 name=__codelineno-26-18 href=#__codelineno-26-18></a>        <span class=n>model</span><span class=o>=</span><span class=s2>&quot;gpt-4-1106-preview&quot;</span><span class=p>,</span>
</span><span id=__span-26-19><a id=__codelineno-26-19 name=__codelineno-26-19 href=#__codelineno-26-19></a>        <span class=n>response_model</span><span class=o>=</span><span class=n>Query</span><span class=p>,</span>
</span><span id=__span-26-20><a id=__codelineno-26-20 name=__codelineno-26-20 href=#__codelineno-26-20></a>        <span class=n>messages</span><span class=o>=</span><span class=p>[</span>
</span><span id=__span-26-21><a id=__codelineno-26-21 name=__codelineno-26-21 href=#__codelineno-26-21></a>            <span class=p>{</span>
</span><span id=__span-26-22><a id=__codelineno-26-22 name=__codelineno-26-22 href=#__codelineno-26-22></a>                <span class=s2>&quot;role&quot;</span><span class=p>:</span> <span class=s2>&quot;system&quot;</span><span class=p>,</span>
</span><span id=__span-26-23><a id=__codelineno-26-23 name=__codelineno-26-23 href=#__codelineno-26-23></a>                <span class=s2>&quot;content&quot;</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&quot;You&#39;re a query understanding system for the Metafor Systems search engine. Today is </span><span class=si>{</span><span class=n>date</span><span class=o>.</span><span class=n>today</span><span class=p>()</span><span class=si>}</span><span class=s2>. Here are some tips: ...&quot;</span><span class=p>,</span>
</span><span id=__span-26-24><a id=__codelineno-26-24 name=__codelineno-26-24 href=#__codelineno-26-24></a>            <span class=p>},</span>
</span><span id=__span-26-25><a id=__codelineno-26-25 name=__codelineno-26-25 href=#__codelineno-26-25></a>            <span class=p>{</span><span class=s2>&quot;role&quot;</span><span class=p>:</span> <span class=s2>&quot;user&quot;</span><span class=p>,</span> <span class=s2>&quot;content&quot;</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&quot;query: </span><span class=si>{</span><span class=n>q</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>},</span>
</span><span id=__span-26-26><a id=__codelineno-26-26 name=__codelineno-26-26 href=#__codelineno-26-26></a>        <span class=p>],</span>
</span><span id=__span-26-27><a id=__codelineno-26-27 name=__codelineno-26-27 href=#__codelineno-26-27></a>    <span class=p>)</span>
</span><span id=__span-26-28><a id=__codelineno-26-28 name=__codelineno-26-28 href=#__codelineno-26-28></a>
</span><span id=__span-26-29><a id=__codelineno-26-29 name=__codelineno-26-29 href=#__codelineno-26-29></a><span class=n>expand_query</span><span class=p>(</span><span class=s2>&quot;What are some recent developments in AI?&quot;</span><span class=p>)</span>
</span></code></pre></div> <div class="language-python highlight"><pre><span></span><code><span id=__span-27-1><a id=__codelineno-27-1 name=__codelineno-27-1 href=#__codelineno-27-1></a><span class=n>Query</span><span class=p>(</span><span class=n>rewritten_query</span><span class=o>=</span><span class=s1>&#39;latest advancements in artificial intelligence&#39;</span><span class=p>,</span> <span class=n>published_daterange</span><span class=o>=</span><span class=n>DateRange</span><span class=p>(</span><span class=n>chain_of_thought</span><span class=o>=</span><span class=s1>&#39;Since the user is asking for recent developments, it would be relevant to look for articles and papers published within the last year. Therefore, setting the start date to a year before today and the end date to today will cover the most recent advancements.&#39;</span><span class=p>,</span> <span class=n>start</span><span class=o>=</span><span class=n>datetime</span><span class=o>.</span><span class=n>date</span><span class=p>(</span><span class=mi>2023</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>31</span><span class=p>),</span> <span class=n>end</span><span class=o>=</span><span class=n>datetime</span><span class=o>.</span><span class=n>date</span><span class=p>(</span><span class=mi>2024</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>31</span><span class=p>)))</span>
</span></code></pre></div> <h4 id=decomposing-questions><a class=toclink href=../../2024/08/01/query-understanding/#decomposing-questions><strong>Decomposing questions</strong></a></h4> <p>Lastly, a lightly more complex example of a problem that can be solved with structured output is decomposing questions. Where you ultimately want to decompose a question into a series of sub-questions that can be answered by a search backend. For example</p> <p>"Whats the difference in populations of jason's home country and canada?"</p> <p>You'd ultimately need to know a few things</p> <ol> <li>Jason's home country</li> <li>The population of Jason's home country</li> <li>The population of Canada</li> <li>The difference between the two</li> </ol> <p>This would not be done correctly as a single query, nor would it be done in parallel, however there are some opportunities try to be parallel since not all of the sub-questions are dependent on each other.</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-28-1><a id=__codelineno-28-1 name=__codelineno-28-1 href=#__codelineno-28-1></a><span class=k>class</span> <span class=nc>Question</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span><span id=__span-28-2><a id=__codelineno-28-2 name=__codelineno-28-2 href=#__codelineno-28-2></a>    <span class=nb>id</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=o>...</span><span class=p>,</span> <span class=n>description</span><span class=o>=</span><span class=s2>&quot;A unique identifier for the question&quot;</span><span class=p>)</span>
</span><span id=__span-28-3><a id=__codelineno-28-3 name=__codelineno-28-3 href=#__codelineno-28-3></a>    <span class=n>query</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=o>...</span><span class=p>,</span> <span class=n>description</span><span class=o>=</span><span class=s2>&quot;The question decomposited as much as possible&quot;</span><span class=p>)</span>
</span><span id=__span-28-4><a id=__codelineno-28-4 name=__codelineno-28-4 href=#__codelineno-28-4></a>    <span class=n>subquestions</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>int</span><span class=p>]</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span>
</span><span id=__span-28-5><a id=__codelineno-28-5 name=__codelineno-28-5 href=#__codelineno-28-5></a>        <span class=n>default_factory</span><span class=o>=</span><span class=nb>list</span><span class=p>,</span>
</span><span id=__span-28-6><a id=__codelineno-28-6 name=__codelineno-28-6 href=#__codelineno-28-6></a>        <span class=n>description</span><span class=o>=</span><span class=s2>&quot;The subquestions that this question is composed of&quot;</span><span class=p>,</span>
</span><span id=__span-28-7><a id=__codelineno-28-7 name=__codelineno-28-7 href=#__codelineno-28-7></a>    <span class=p>)</span>
</span><span id=__span-28-8><a id=__codelineno-28-8 name=__codelineno-28-8 href=#__codelineno-28-8></a>
</span><span id=__span-28-9><a id=__codelineno-28-9 name=__codelineno-28-9 href=#__codelineno-28-9></a><span class=k>class</span> <span class=nc>QueryPlan</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span><span id=__span-28-10><a id=__codelineno-28-10 name=__codelineno-28-10 href=#__codelineno-28-10></a>    <span class=n>root_question</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=o>...</span><span class=p>,</span> <span class=n>description</span><span class=o>=</span><span class=s2>&quot;The root question that the user asked&quot;</span><span class=p>)</span>
</span><span id=__span-28-11><a id=__codelineno-28-11 name=__codelineno-28-11 href=#__codelineno-28-11></a>    <span class=n>plan</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>Question</span><span class=p>]</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span>
</span><span id=__span-28-12><a id=__codelineno-28-12 name=__codelineno-28-12 href=#__codelineno-28-12></a>        <span class=o>...</span><span class=p>,</span> <span class=n>description</span><span class=o>=</span><span class=s2>&quot;The plan to answer the root question and its subquestions&quot;</span>
</span><span id=__span-28-13><a id=__codelineno-28-13 name=__codelineno-28-13 href=#__codelineno-28-13></a>    <span class=p>)</span>
</span><span id=__span-28-14><a id=__codelineno-28-14 name=__codelineno-28-14 href=#__codelineno-28-14></a>
</span><span id=__span-28-15><a id=__codelineno-28-15 name=__codelineno-28-15 href=#__codelineno-28-15></a><span class=n>retrieval</span> <span class=o>=</span> <span class=n>client</span><span class=o>.</span><span class=n>chat</span><span class=o>.</span><span class=n>completions</span><span class=o>.</span><span class=n>create</span><span class=p>(</span>
</span><span id=__span-28-16><a id=__codelineno-28-16 name=__codelineno-28-16 href=#__codelineno-28-16></a>    <span class=n>model</span><span class=o>=</span><span class=s2>&quot;gpt-4-1106-preview&quot;</span><span class=p>,</span>
</span><span id=__span-28-17><a id=__codelineno-28-17 name=__codelineno-28-17 href=#__codelineno-28-17></a>    <span class=n>response_model</span><span class=o>=</span><span class=n>QueryPlan</span><span class=p>,</span>
</span><span id=__span-28-18><a id=__codelineno-28-18 name=__codelineno-28-18 href=#__codelineno-28-18></a>    <span class=n>messages</span><span class=o>=</span><span class=p>[</span>
</span><span id=__span-28-19><a id=__codelineno-28-19 name=__codelineno-28-19 href=#__codelineno-28-19></a>        <span class=p>{</span>
</span><span id=__span-28-20><a id=__codelineno-28-20 name=__codelineno-28-20 href=#__codelineno-28-20></a>            <span class=s2>&quot;role&quot;</span><span class=p>:</span> <span class=s2>&quot;system&quot;</span><span class=p>,</span>
</span><span id=__span-28-21><a id=__codelineno-28-21 name=__codelineno-28-21 href=#__codelineno-28-21></a>            <span class=s2>&quot;content&quot;</span><span class=p>:</span> <span class=s2>&quot;You are a query understanding system capable of decomposing a question into subquestions.&quot;</span><span class=p>,</span>
</span><span id=__span-28-22><a id=__codelineno-28-22 name=__codelineno-28-22 href=#__codelineno-28-22></a>        <span class=p>},</span>
</span><span id=__span-28-23><a id=__codelineno-28-23 name=__codelineno-28-23 href=#__codelineno-28-23></a>        <span class=p>{</span>
</span><span id=__span-28-24><a id=__codelineno-28-24 name=__codelineno-28-24 href=#__codelineno-28-24></a>            <span class=s2>&quot;role&quot;</span><span class=p>:</span> <span class=s2>&quot;user&quot;</span><span class=p>,</span>
</span><span id=__span-28-25><a id=__codelineno-28-25 name=__codelineno-28-25 href=#__codelineno-28-25></a>            <span class=s2>&quot;content&quot;</span><span class=p>:</span> <span class=s2>&quot;What is the difference between the population of jason&#39;s home country and canada?&quot;</span><span class=p>,</span>
</span><span id=__span-28-26><a id=__codelineno-28-26 name=__codelineno-28-26 href=#__codelineno-28-26></a>        <span class=p>},</span>
</span><span id=__span-28-27><a id=__codelineno-28-27 name=__codelineno-28-27 href=#__codelineno-28-27></a>    <span class=p>],</span>
</span><span id=__span-28-28><a id=__codelineno-28-28 name=__codelineno-28-28 href=#__codelineno-28-28></a><span class=p>)</span>
</span><span id=__span-28-29><a id=__codelineno-28-29 name=__codelineno-28-29 href=#__codelineno-28-29></a>
</span><span id=__span-28-30><a id=__codelineno-28-30 name=__codelineno-28-30 href=#__codelineno-28-30></a><span class=nb>print</span><span class=p>(</span><span class=n>retrieval</span><span class=o>.</span><span class=n>model_dump_json</span><span class=p>(</span><span class=n>indent</span><span class=o>=</span><span class=mi>4</span><span class=p>))</span>
</span></code></pre></div> <div class="language-python highlight"><pre><span></span><code><span id=__span-29-1><a id=__codelineno-29-1 name=__codelineno-29-1 href=#__codelineno-29-1></a><span class=p>{</span>
</span><span id=__span-29-2><a id=__codelineno-29-2 name=__codelineno-29-2 href=#__codelineno-29-2></a>    <span class=s2>&quot;root_question&quot;</span><span class=p>:</span> <span class=s2>&quot;What is the difference between the population of Jason&#39;s home country and Canada?&quot;</span><span class=p>,</span>
</span><span id=__span-29-3><a id=__codelineno-29-3 name=__codelineno-29-3 href=#__codelineno-29-3></a>    <span class=s2>&quot;plan&quot;</span><span class=p>:</span> <span class=p>[</span>
</span><span id=__span-29-4><a id=__codelineno-29-4 name=__codelineno-29-4 href=#__codelineno-29-4></a>        <span class=p>{</span>
</span><span id=__span-29-5><a id=__codelineno-29-5 name=__codelineno-29-5 href=#__codelineno-29-5></a>            <span class=s2>&quot;id&quot;</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span>
</span><span id=__span-29-6><a id=__codelineno-29-6 name=__codelineno-29-6 href=#__codelineno-29-6></a>            <span class=s2>&quot;query&quot;</span><span class=p>:</span> <span class=s2>&quot;What is the population of Jason&#39;s home country?&quot;</span><span class=p>,</span>
</span><span id=__span-29-7><a id=__codelineno-29-7 name=__codelineno-29-7 href=#__codelineno-29-7></a>            <span class=s2>&quot;subquestions&quot;</span><span class=p>:</span> <span class=p>[]</span>
</span><span id=__span-29-8><a id=__codelineno-29-8 name=__codelineno-29-8 href=#__codelineno-29-8></a>        <span class=p>},</span>
</span><span id=__span-29-9><a id=__codelineno-29-9 name=__codelineno-29-9 href=#__codelineno-29-9></a>        <span class=p>{</span>
</span><span id=__span-29-10><a id=__codelineno-29-10 name=__codelineno-29-10 href=#__codelineno-29-10></a>            <span class=s2>&quot;id&quot;</span><span class=p>:</span> <span class=mi>2</span><span class=p>,</span>
</span><span id=__span-29-11><a id=__codelineno-29-11 name=__codelineno-29-11 href=#__codelineno-29-11></a>            <span class=s2>&quot;query&quot;</span><span class=p>:</span> <span class=s2>&quot;What is the population of Canada?&quot;</span><span class=p>,</span>
</span><span id=__span-29-12><a id=__codelineno-29-12 name=__codelineno-29-12 href=#__codelineno-29-12></a>            <span class=s2>&quot;subquestions&quot;</span><span class=p>:</span> <span class=p>[]</span>
</span><span id=__span-29-13><a id=__codelineno-29-13 name=__codelineno-29-13 href=#__codelineno-29-13></a>        <span class=p>},</span>
</span><span id=__span-29-14><a id=__codelineno-29-14 name=__codelineno-29-14 href=#__codelineno-29-14></a>        <span class=p>{</span>
</span><span id=__span-29-15><a id=__codelineno-29-15 name=__codelineno-29-15 href=#__codelineno-29-15></a>            <span class=s2>&quot;id&quot;</span><span class=p>:</span> <span class=mi>3</span><span class=p>,</span>
</span><span id=__span-29-16><a id=__codelineno-29-16 name=__codelineno-29-16 href=#__codelineno-29-16></a>            <span class=s2>&quot;query&quot;</span><span class=p>:</span> <span class=s2>&quot;What is the difference between two population numbers?&quot;</span><span class=p>,</span>
</span><span id=__span-29-17><a id=__codelineno-29-17 name=__codelineno-29-17 href=#__codelineno-29-17></a>            <span class=s2>&quot;subquestions&quot;</span><span class=p>:</span> <span class=p>[</span>
</span><span id=__span-29-18><a id=__codelineno-29-18 name=__codelineno-29-18 href=#__codelineno-29-18></a>                <span class=mi>1</span><span class=p>,</span>
</span><span id=__span-29-19><a id=__codelineno-29-19 name=__codelineno-29-19 href=#__codelineno-29-19></a>                <span class=mi>2</span>
</span><span id=__span-29-20><a id=__codelineno-29-20 name=__codelineno-29-20 href=#__codelineno-29-20></a>            <span class=p>]</span>
</span><span id=__span-29-21><a id=__codelineno-29-21 name=__codelineno-29-21 href=#__codelineno-29-21></a>        <span class=p>}</span>
</span><span id=__span-29-22><a id=__codelineno-29-22 name=__codelineno-29-22 href=#__codelineno-29-22></a>    <span class=p>]</span>
</span><span id=__span-29-23><a id=__codelineno-29-23 name=__codelineno-29-23 href=#__codelineno-29-23></a><span class=p>}</span>
</span></code></pre></div> </div> </article> <article class="md-post md-post--excerpt"> <header class=md-post__header> <nav class="md-post__authors md-typeset"> <span class=md-author> <img src=https://github.com/deweyamer.png alt=Dewey> </span> </nav> <div class="md-post__meta md-meta"> <ul class=md-meta__list> <li class=md-meta__item> <time datetime="2024-07-13 00:00:00">July 13, 2024</time></li> <li class=md-meta__item> in <a href=./ class=md-meta__link>RAG</a>, <a href=../conversations/ class=md-meta__link>Conversations</a></li> <li class=md-meta__item> 7 min read </li> </ul> </div> </header> <div class="md-post__content md-typeset"> <h2 id=how-to-manage-chat-history-for-your-chatbot><a href=../../2024/07/13/how-to-manage-chat-history-for-your-chatbot/ class=toclink>How to manage chat history for your chatbot?</a></h2> <h3 id=task-introduction><a class=toclink href=../../2024/07/13/how-to-manage-chat-history-for-your-chatbot/#task-introduction>Task Introduction</a></h3> <p>引入多轮对话的目的在于，尽量降低token的消耗，chatbot可以结合历史会话达到更好的效果。可以考虑到，token的消耗以及最相关的chat history是解决这一问题需要平衡的两面。</p> <h3 id=some-approaches-to-solving-the-problem><a class=toclink href=../../2024/07/13/how-to-manage-chat-history-for-your-chatbot/#some-approaches-to-solving-the-problem>Some approaches to solving the problem</a></h3> <p>有以下几种方法处理chat history</p> <table> <thead> <tr> <th></th> <th>pros</th> <th>cons</th> </tr> </thead> <tbody> <tr> <td>default</td> <td>1. 完整的存储chat history2. 最简单直接</td> <td>1. token消耗巨大，时延巨大2. 达到LLm token limit，无法记住超过限制的对话</td> </tr> <tr> <td>summarizing</td> <td>1. 缩短了chat history的token数量2. 可以容纳更长的对话轮次3. 相对直接的视线，简单易懂</td> <td>1. chat history完全依赖于LLM的摘要能力，2. 需要使用LLM对chat history摘要（消耗token）</td> </tr> <tr> <td>memory</td> <td>1. 具备近期完整的chat history</td> <td>1. 久远的chat history没有保留</td> </tr> <tr> <td>trunk &amp; retrieval</td> <td>1. token消耗少2. 选择最相关的chat history chunk</td> <td>1. 不是完整的chat history，存在语义偏差2. 可能错过最近的chat history</td> </tr> </tbody> </table> <nav class=md-post__action> <a href=../../2024/07/13/how-to-manage-chat-history-for-your-chatbot/ > Continue reading </a> </nav> </div> </article> <article class="md-post md-post--excerpt"> <header class=md-post__header> <nav class="md-post__authors md-typeset"> <span class=md-author> <img src=https://github.com/deweyamer.png alt=Dewey> </span> </nav> <div class="md-post__meta md-meta"> <ul class=md-meta__list> <li class=md-meta__item> <time datetime="2024-06-01 00:00:00">June 1, 2024</time></li> <li class=md-meta__item> in <a href=./ class=md-meta__link>RAG</a>, <a href=../embedding/ class=md-meta__link>Embedding</a></li> <li class=md-meta__item> 12 min read </li> </ul> </div> </header> <div class="md-post__content md-typeset"> <h2 id=embedding-fine-tuning><a href=../../2024/06/01/embedding-fine-tuning/ class=toclink>Embedding fine-tuning</a></h2> <p>Tags: Embedding</p> <h3 id=semantic-search><a class=toclink href=../../2024/06/01/embedding-fine-tuning/#semantic-search>Semantic search</a></h3> <h4 id=symmetric-vs-asymmetric-semantic-search><a class=toclink href=../../2024/06/01/embedding-fine-tuning/#symmetric-vs-asymmetric-semantic-search><strong>Symmetric vs. Asymmetric Semantic Search</strong></a></h4> <ul> <li>对称语义搜索指的是query和语料中的实体存在交叉（句式，单词）。例子：基于当前的问题去搜索相似的问题，比如：如何在线学习Python？它也可以是：如何在网上学习Python？</li> <li>非对称语义搜索通常是，从一个query检索得到一段较长的语料。例如：什么是Python？你想要的结果是Python的具体定义，比如：Python是可解释的高级编程语言…。对于非对称任务，query和语料通常不存在交叉（句式，单词）。</li> </ul> <nav class=md-post__action> <a href=../../2024/06/01/embedding-fine-tuning/ > Continue reading </a> </nav> </div> </article> <article class="md-post md-post--excerpt"> <header class=md-post__header> <nav class="md-post__authors md-typeset"> <span class=md-author> <img src=https://github.com/deweyamer.png alt=Dewey> </span> </nav> <div class="md-post__meta md-meta"> <ul class=md-meta__list> <li class=md-meta__item> <time datetime="2024-05-22 00:00:00">May 22, 2024</time></li> <li class=md-meta__item> in <a href=./ class=md-meta__link>RAG</a></li> <li class=md-meta__item> 10 min read </li> </ul> </div> </header> <div class="md-post__content md-typeset"> <h2 id=prompt-optim><a href=../../2024/05/22/prompt-optim/ class=toclink>Prompt Optim</a></h2> <h3 id=prompt><a class=toclink href=../../2024/05/22/prompt-optim/#prompt>Prompt结构化</a></h3> <ul> <li>语法<ul> <li>这个结构支持 <code>Markdown</code> 语法, 也支持 YAML 语法, 甚至纯文本手动敲空格和回车都可以. 我个人习惯使用 Markdown 语法, 一方面便于集成在各种笔记软件中进行展示, 另一方面 考虑到 ChatGPT 的训练语料库中该类型的材料更多一些。</li> </ul> </li> <li> <p>结构</p> <p>结构中的信息, 可以根据自己需要进行增减, 从中总结的常用模块包括:</p> <ul> <li><strong># Role: <name> :</strong> 指定角色会让 GPT 聚焦在对应领域进行信息输出</li> <li><strong>## Profile author/version/description :</strong> Credit 和 迭代版本记录</li> <li><strong>## Goals:</strong> 一句话描述 Prompt 目标, 让 GPT Attention 聚焦起来</li> <li><strong>## Constrains:</strong> 描述限制条件, 其实是在帮 GPT 进行剪枝, 减少不必要分支的计算</li> <li><strong>## Skills:</strong> 描述技能项, 强化对应领域的信息权重</li> <li><strong>## Workflow:</strong> 重点中的重点, 你希望 Prompt 按什么方式来对话和输出</li> <li><strong># Initialization:</strong> 冷启动时的对白, 也是一个强调需注意重点的机会</li> <li><strong># Output Format:</strong> 输出内容的格式</li> </ul> </li> </ul> <nav class=md-post__action> <a href=../../2024/05/22/prompt-optim/ > Continue reading </a> </nav> </div> </article> <article class="md-post md-post--excerpt"> <header class=md-post__header> <nav class="md-post__authors md-typeset"> <span class=md-author> <img src=https://github.com/deweyamer.png alt=Dewey> </span> </nav> <div class="md-post__meta md-meta"> <ul class=md-meta__list> <li class=md-meta__item> <time datetime="2024-04-16 00:00:00">April 16, 2024</time></li> <li class=md-meta__item> in <a href=./ class=md-meta__link>RAG</a></li> <li class=md-meta__item> 10 min read </li> </ul> </div> </header> <div class="md-post__content md-typeset"> <h2 id=rag-evaluate><a href=../../2024/04/16/rag-evaluate/ class=toclink>RAG-evaluate</a></h2> <h3 id=categories-of-metrics><a class=toclink href=../../2024/04/16/rag-evaluate/#categories-of-metrics>Categories of metrics:</a></h3> <ul> <li>Metrics based on the ground truth</li> <li>Metrics without the ground truth</li> <li>Metrics based on LLM response</li> </ul> <nav class=md-post__action> <a href=../../2024/04/16/rag-evaluate/ > Continue reading </a> </nav> </div> </article> <article class="md-post md-post--excerpt"> <header class=md-post__header> <nav class="md-post__authors md-typeset"> <span class=md-author> <img src=https://github.com/deweyamer.png alt=Dewey> </span> </nav> <div class="md-post__meta md-meta"> <ul class=md-meta__list> <li class=md-meta__item> <time datetime="2024-01-31 00:00:00">January 31, 2024</time></li> <li class=md-meta__item> in <a href=./ class=md-meta__link>RAG</a></li> <li class=md-meta__item> 10 min read </li> </ul> </div> </header> <div class="md-post__content md-typeset"> <h2 id=gptrag><a href=../../2024/01/31/%E6%BC%AB%E8%B0%88gptrag/ class=toclink>漫谈GPT&amp;RAG</a></h2> <h3 id=chatgpt><a class=toclink href=../../2024/01/31/%E6%BC%AB%E8%B0%88gptrag/#chatgpt>ChatGPT漫谈</a></h3> <p>由于其超大的参数量以及训练方式，大语言模型具备了更强的语义理解能力，一方面，它现在成为了对话机器人的最佳实践方式，另一方面，在基本的NLP任务中表现出了极强的能力。</p> <p>现阶段，有两种成本较低的方式可以提高大模型在特定任务或特定领域的能力</p> <ol> <li>调优Prompt，这是最具性价比的调整方式。</li> <li>SFT。针对特定任务，特定领域，对大模型微调。</li> </ol> <p>虽然大模型的能力十分惊艳，但是它也有一些问题亟待解决。首先是大模型生成的结果并不置信（幻觉Hallucination），其次，如果没有对齐人类价值观（Alignment），大模型会生成一些有害的回答，然后是安全问题：比如大模型如何避免被劫持，生成有害的回答，以及生成数据的版权问题。</p> <nav class=md-post__action> <a href=../../2024/01/31/%E6%BC%AB%E8%B0%88gptrag/ > Continue reading </a> </nav> </div> </article> <article class="md-post md-post--excerpt"> <header class=md-post__header> <nav class="md-post__authors md-typeset"> <span class=md-author> <img src=https://github.com/deweyamer.png alt=Dewey> </span> </nav> <div class="md-post__meta md-meta"> <ul class=md-meta__list> <li class=md-meta__item> <time datetime="2023-11-11 00:00:00">November 11, 2023</time></li> <li class=md-meta__item> in <a href=./ class=md-meta__link>RAG</a></li> <li class=md-meta__item> 15 min read </li> </ul> </div> </header> <div class="md-post__content md-typeset"> <h2 id=rag-survey><a href=../../2023/11/11/rag-survey/ class=toclink>RAG-Survey</a></h2> <p><img alt="Abstract of RAG.png" src=../../RAG-Survey-docs/Abstract_of_RAG.png></p> <p>为了便于理解整体逻辑，只画出了一些核心步骤，粗略分为3部分：</p> <ul> <li>Preprocess data stage: 这个阶段需要我们将外部数据进行处理，这里列举了两种方式：<ol> <li>构建索引，便于后续进行倒排检索；</li> <li>构建vector store，这里常见的问题是数据的长度可能很长，需要根据一些规则和语义进行语句或者段落的切分，称之为chunks，然后将chunks编码为embedding，存储至vector store。</li> </ol> </li> <li>Retrieval stage: 基于用户query进行检索，目的是在prompt引入召回的相关文档，减少大模型幻觉以及产生错误答案，基于上述构建的两种方式进行检索。</li> <li>LLM stage: 基于用户query和召回的相关文档构建prompt，送入LLM，产生最终的回答</li> </ul> <nav class=md-post__action> <a href=../../2023/11/11/rag-survey/ > Continue reading </a> </nav> </div> </article> <nav class=md-pagination> </nav> </div> </div> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> <button type=button class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg> Back to top </button> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright &copy; 2023 ~ now | Dewey Amer </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <div class=md-progress data-md-component=progress role=progressbar></div> <script id=__config type=application/json>{"base": "../../..", "features": ["announce.dismiss", "content.action.edit", "content.action.view", "content.code.annotate", "content.code.copy", "content.tooltips", "navigation.expand", "navigation.indexes", "navigation.instant.prefetch", "navigation.instant.progress", "navigation.path", "navigation.sections", "navigation.tabs", "navigation.tabs.sticky", "navigation.top", "navigation.tracking", "search.highlight", "search.share", "search.suggest", "toc.follow"], "search": "../../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script> <script src=../../../assets/javascripts/bundle.fe8b6f2b.min.js></script> <script src=../../../javascripts/mathjax.js></script> <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script> </body> </html>